<script src="script/at-doc-parser.js"></script>
<link rel="import" href="../at-core-activity/at-core-activity.html">

<dom-module id="at-doc-parser">
  <style>

  </style>
  <template>
    <at-core-activity id="loader" url={{url}} auto="true" handle-as="text"></at-core-activity>
  </template>
  <script>
    'use strict';
    Polymer({
      is: 'at-doc-parser',
      properties: {
        url: {
          type: String,
          value: ''
        },
        value: {
          type: Object,
          value: ''
        }
      },
      _scopeCssViaAttr: true,
      ready: function() {
        var
          loader = this.$.loader,
          url = this.url,
          self = this;

        var _isFunction = function(obj) {
          return Object.prototype.toString.apply(obj) === "[object Function]";
        }

        loader.addEventListener('response', function(event) {
          var text = event.detail;

          if (text) {

            self.importHref(self.url, function(event) {
              // import successful
              var importedContent = event.target.import;
              var domModule = importedContent.querySelector('dom-module');
              var elementName = domModule.getAttribute('id');
              var element = document.createElement(elementName);
              // we need this to find out the function names
              var elementProto = element.__proto__;
              var entity = {
                name: elementName,
                description: elementName,
                properties: [],
                methods: [],
                events: []
              };
              var properties = element.properties;
              Object.keys(properties).forEach(function (propName, index) {
                var propDef = properties[propName],
                type = typeof propDef.type();
                var defValue = propDef.value;
                if (_isFunction(propDef.value)) {
                  defValue = propDef.value();
                } else if (defValue === '') {
                  defValue = 'empty';
                }
                var property = {
                  name: propName,
                  description: propName,
                  type: type,
                  default: defValue
                }
                entity.properties.push(property);
              });

              var entities = DocParser.parse(text, entity);
              if (!entities || entities.length === 0) {
                entities = [{
                  name: url.split('/').pop(),
                  description: '**Undocumented**'
                }];
              }
              self.value = entities;
              self.fire('value-changed', {
                value: self.value
              });

            }, function(event) {
              // error; do nothing
            });

          }
        });
      }
    });
  </script>
</dom-module>
